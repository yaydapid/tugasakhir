"use strict";(self.webpackChunkngx_admin_demo=self.webpackChunkngx_admin_demo||[]).push([[523],{2523:(j,C,r)=>{r.r(C),r.d(C,{CMLModule:()=>J});var g=r(9808),y=r(4738),h=r(2497),t=r(5e3),l=r(3254),p=r(3075);let f=(()=>{class i{constructor(e){this.dialog=e}closeDialog(e=null){e||this.dialog.close(),e&&this.dialog.close(e)}}return i.\u0275fac=function(e){return new(e||i)(t.Y36(l.X4l))},i.\u0275cmp=t.Xpm({type:i,selectors:[["ngx-add-cml"]],inputs:{dialogData:"dialogData"},decls:32,vars:9,consts:[[1,"w-100","d-flex","justify-content-center","mt-5"],[1,"mt-5"],[1,"d-flex"],[1,"w-100"],[1,"flex-shrink-1"],["nbButton","","status","danger","size","tiny",3,"click"],["icon","close-outline"],[3,"ngSubmit"],["cmlForm","ngForm"],[1,""],["for","cml_id",1,"d-block"],["type","text","id","cml_id","nbInput","","fieldSize","small","required","","name","cml_id",3,"ngModel"],["for","gauge_point",1,"d-block"],["type","text","id","gauge_point","nbInput","","fieldSize","small","required","","name","gauge_point",3,"ngModel"],["for","point_location",1,"d-block"],["type","text","id","point_location","nbInput","","fieldSize","small","required","","name","point_location",3,"ngModel"],["for","last_thickness_reading",1,"d-block"],["type","text","id","last_thickness_reading","nbInput","","fieldSize","small","required","","name","last_thickness_reading",3,"ngModel"],["for","last_thickness_reading_date",1,"d-block"],["type","text","id","last_thickness_reading_date","required","","nbInput","","fieldSize","small","name","last_thickness_reading_date",3,"nbDatepicker","ngModel"],["datepicker",""],["nbButton","","size","small","status","success","type","submit",1,"mt-2","w-100",3,"disabled"]],template:function(e,n){if(1&e){const a=t.EpF();t.TgZ(0,"div",0)(1,"nb-card",1)(2,"nb-card-header",2)(3,"h5",3),t._uU(4),t.qZA(),t.TgZ(5,"div",4)(6,"button",5),t.NdJ("click",function(){return n.closeDialog()}),t._UZ(7,"nb-icon",6),t.qZA()()(),t.TgZ(8,"nb-card-body")(9,"form",7,8),t.NdJ("ngSubmit",function(){t.CHM(a);const u=t.MAs(10);return n.closeDialog(u.value)}),t.TgZ(11,"div",9)(12,"div")(13,"label",10),t._uU(14,"CML ID"),t.qZA(),t._UZ(15,"input",11),t.TgZ(16,"label",12),t._uU(17,"Gaguge Point"),t.qZA(),t._UZ(18,"input",13),t.TgZ(19,"label",14),t._uU(20,"Point Location"),t.qZA(),t._UZ(21,"input",15),t.TgZ(22,"label",16),t._uU(23,"Last Thickness Reading"),t.qZA(),t._UZ(24,"input",17),t.TgZ(25,"label",18),t._uU(26,"Last Thickness Reading Date"),t.qZA(),t._UZ(27,"input",19)(28,"nb-datepicker",null,20),t.qZA(),t.TgZ(30,"button",21),t._uU(31),t.qZA()()()()()()}if(2&e){const a=t.MAs(10),o=t.MAs(29);t.xp6(4),t.Oqu(null==n.dialogData?null:n.dialogData.title),t.xp6(11),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.cml_id),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.gauge_point),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.point_location),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.last_thickness_reading),t.xp6(3),t.Q6J("nbDatepicker",o)("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.last_thickness_reading_date),t.xp6(3),t.Q6J("disabled",!a.form.valid),t.xp6(1),t.Oqu(null==n.dialogData?null:n.dialogData.title)}},directives:[l.Asz,l.ndF,l.DPz,l.fMN,l.yKW,p._Y,p.JL,p.F,l.h8i,p.Fj,p.Q7,p.JJ,p.On,l.$kf,l.B4C],encapsulation:2}),i})();var M=r(3858),v=r(3872),_=r(574),D=r(2340),L=r(520);let x=(()=>{class i{constructor(e){this.httpClient=e,this.apiUrl=D.N.apiUrl}getCMLs(){return this.httpClient.get(this.apiUrl+"/cml")}getCML(e){return this.httpClient.get(this.apiUrl+"/cml/"+e)}addCML(e){return this.httpClient.post(this.apiUrl+"/cml",e)}deleteCML(e){return this.httpClient.delete(this.apiUrl+"/cml/"+e)}updateCML(e){return this.httpClient.put(this.apiUrl+"/cml/"+e.id,e)}importCML(e){return this.httpClient.post(this.apiUrl+"/import_cmls",e)}}return i.\u0275fac=function(e){return new(e||i)(t.LFG(L.eN))},i.\u0275prov=t.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var k=r(7024);function T(i,c){if(1&i){const e=t.EpF();t.TgZ(0,"button",2),t.NdJ("click",function(){const o=t.CHM(e).$implicit,u=t.MAs(2),s=t.oxw();return"New"==o.name?s.addCML():"Import"==o.name?u.click():"Export"==o.name?s.exportExcelFile():"Print"==o.name?s.printCML():null}),t.TgZ(1,"input",3,4),t.NdJ("change",function(a){return t.CHM(e),t.oxw().importExcelFile(a)}),t.qZA(),t._UZ(3,"nb-icon",5),t.TgZ(4,"span"),t._uU(5),t.qZA()()}if(2&i){const e=c.$implicit,n=t.oxw();let a;t.Q6J("disabled",!("Export"!=(null==e?null:e.name)&&"Print"!=(null==e?null:e.name)||null!=n.tableData&&n.tableData.length)),t.xp6(3),t.Q6J("icon",e.icon)("pack",null!==(a=e.pack)&&void 0!==a?a:"eva"),t.xp6(2),t.Oqu(e.name)}}const A=function(){return{name:"New",icon:"plus-outline"}},S=function(){return{name:"Import",icon:"download-outline"}},Z=function(){return{name:"Export",icon:"upload-outline"}},F=function(){return{name:"Print",icon:"printer-outline"}},O=function(i,c,e,n){return[i,c,e,n]},U=[{path:"",component:(()=>{class i{constructor(e,n,a,o,u,s){this.activatedroute=e,this.cmlService=n,this.dialogService=a,this.datePipe=o,this.toastrService=u,this.variables=s,this.tableData=[],this.columnDetails=[{type:"text",prop:"cml_id",head:"CML Id",width:"200px"},{type:"text",prop:"gauge_point",head:"Gauge Point",width:"200px"},{type:"text",prop:"point_location",head:"Point Location",width:"200px"},{type:"text",prop:"nominal_thickness",head:"Nominal Thickness (mm)",width:"200px"},{type:"text",prop:"min_required_thickness",head:"Min. Required Thickness (mm)",width:"200px"},{type:"text",prop:"last_thickness_reading",head:"Last Thickness Reading (mm)",width:"200px"},{type:"text",prop:"last_thickness_reading_date",head:"Last Thickness Date",width:"200px"},{type:"text",prop:"calculated_cr",head:"Calculated CR (mm/Year)",width:"200px"},{type:"button",prop:"edit",width:"80px",button:[{icon:"edit-outline",status:"info",title:"edit-cml"},{icon:"trash-2-outline",status:"danger",title:"delete-cml"}]}],this.transformExcelDate=d=>null==d?"":new Date(Math.round(86400*(d-25569)*1e3))}ngOnInit(){this.pipingId=this.activatedroute.snapshot.paramMap.get("id"),this.cmlService.getCML(this.pipingId).subscribe(({data:e,piping:n})=>{this.piping=n;let a=["All"];this.tableHeader={title:n.piping_id,filter:[{name:"Year",value:a.sort((s,d)=>s-d),title:"cml-year"}]};const{nominal_thickness:o,min_required_thickness:u}=this.variables.getAssetsFormula(n);this.tableData=e.map(s=>{const d=this.variables.getCalculatedLTCR(Object.assign(Object.assign({},s),n));return a.includes(s.year)||a.push(s.year),Object.assign(Object.assign({},s),{nominal_thickness:o,min_required_thickness:u.toFixed(4),calculated_cr:d.toFixed(3)})}),this.viewTable.regenerateTable(this.tableData)})}onClickTable(e,n){if("delete-cml"==n&&this.deleteCML(e),"edit-cml"==n&&this.updateCML(e),"cml-year"==n){let a;a="All"==e?this.tableData:this.tableData.filter(({year:o})=>o==e),this.viewTable.regenerateTable(a)}}exportExcelFile(){console.log("export")}printCML(){console.log("print")}addCML(){this.dialogService.open(f,{context:{dialogData:{title:"Add CML"}}}).onClose.subscribe(e=>{e&&(e=this.reconstructCMLData(e),this.cmlService.addCML(e).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success.")))})}updateCML(e){this.dialogService.open(f,{context:{dialogData:{title:"Update CML",data:Object.assign(Object.assign({},e),{last_thickness_reading_date:new Date(e.last_thickness_reading_date)})}}}).onClose.subscribe(n=>{n&&(n=Object.assign(Object.assign({},this.reconstructCMLData(n)),{id:e.id}),this.cmlService.updateCML(n).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success.")))})}reconstructCMLData(e){return Object.assign(Object.assign({},e),{piping_id:this.piping.id,last_thickness_reading_date:this.datePipe.transform(e.last_thickness_reading_date,"yyyy-MM-dd"),year:new Date(e.last_thickness_reading_date).getFullYear()})}deleteCML(e){this.dialogService.open(v.F,{context:{dialogData:{title:"Add CML",name:e.cml_id,id:e.id}}}).onClose.subscribe(n=>{n&&this.cmlService.deleteCML(n.id).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been deleted.","Your request success."))})}importExcelFile(e){const n=e.target.files[0];if(!n)return;const a=new FileReader;a.readAsBinaryString(n),a.onload=o=>{const s=_.ij(o.target.result,{type:"binary"});console.log(s);const d=s.Sheets[s.SheetNames[0]];let m=0,b=!0;for(;b;){if(m>100&&(b=!1),d["A"+m]){b=!1;break}m++}const q=_.P6.sheet_to_json(d,{range:m-1,defval:""});this.reconstructDataExcel(q)}}reconstructDataExcel(e){const n=e.map(({"CML ID":a,"Gauge Point":o,"Point Location":u,"Last Thickness":s,"Last Thickness Reading Date":d})=>{d=this.transformExcelDate(d);const m=new Date(d).getFullYear();return{cml_id:a,gauge_point:o,point_location:u,last_thickness_reading:s,last_thickness_reading_date:d=this.datePipe.transform(d,"yyyy-MM-dd"),year:m,piping_id:this.pipingId}});this.cmlService.importCML(n).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success."))}}return i.\u0275fac=function(e){return new(e||i)(t.Y36(h.gz),t.Y36(x),t.Y36(l.Gln),t.Y36(g.uU),t.Y36(l.quB),t.Y36(k.L))},i.\u0275cmp=t.Xpm({type:i,selectors:[["ngx-cml"]],viewQuery:function(e,n){if(1&e&&t.Gf(M.V,5),2&e){let a;t.iGM(a=t.CRH())&&(n.viewTable=a.first)}},decls:4,vars:13,consts:[["nbButton","","outline","","size","small","status","primary","class","m-2",3,"disabled","click",4,"ngFor","ngForOf"],[3,"tableHeader","columnDetails","tableData","onClickTable"],["nbButton","","outline","","size","small","status","primary",1,"m-2",3,"disabled","click"],["type","file","accept",".xls,.xlsx",2,"display","none",3,"change"],["importExcel",""],[1,"m-1",3,"icon","pack"]],template:function(e,n){1&e&&(t.TgZ(0,"nb-card")(1,"nb-card-body"),t.YNc(2,T,6,4,"button",0),t.qZA()(),t.TgZ(3,"ngx-mat-table",1),t.NdJ("onClickTable",function(o){return n.onClickTable(o.data,o.title)}),t.qZA()),2&e&&(t.xp6(2),t.Q6J("ngForOf",t.l5B(8,O,t.DdM(4,A),t.DdM(5,S),t.DdM(6,Z),t.DdM(7,F))),t.xp6(1),t.Q6J("tableHeader",n.tableHeader)("columnDetails",n.columnDetails)("tableData",n.tableData))},directives:[l.Asz,l.yKW,g.sg,l.DPz,l.fMN,M.V],encapsulation:2}),i.\u0275prov=t.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),data:{routename:"cml"}}];let Y=(()=>{class i{}return i.\u0275fac=function(e){return new(e||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[[h.Bz.forChild(U)],h.Bz]}),i})();var I=r(2356),z=r(9511);let J=(()=>{class i{}return i.\u0275fac=function(e){return new(e||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[[g.ez,y.O,Y,l.zyh,l.KdK,l.nKr,l.T2N,I.Z,z.H,p.u5,l.OA,l.LW9.forRoot({destroyByClick:!0,duration:3e3,position:l.fe3.BOTTOM_RIGHT,preventDuplicates:!0,limit:3})]]}),i})()}}]);