"use strict";(self.webpackChunkngx_admin_demo=self.webpackChunkngx_admin_demo||[]).push([[531],{531:($,C,r)=>{r.r(C),r.d(C,{CMLModule:()=>G});var h=r(9808),L=r(4738),g=r(2497),t=r(5e3),s=r(3254),p=r(3075);let _=(()=>{class a{constructor(e){this.dialog=e}closeDialog(e=null){e||this.dialog.close(),e&&this.dialog.close(e)}}return a.\u0275fac=function(e){return new(e||a)(t.Y36(s.X4l))},a.\u0275cmp=t.Xpm({type:a,selectors:[["ngx-add-cml"]],inputs:{dialogData:"dialogData"},decls:32,vars:9,consts:[[1,"w-100","d-flex","justify-content-center","mt-5"],[1,"mt-5"],[1,"d-flex"],[1,"w-100"],[1,"flex-shrink-1"],["nbButton","","status","danger","size","tiny",3,"click"],["icon","close-outline"],[3,"ngSubmit"],["cmlForm","ngForm"],[1,""],["for","cml_id",1,"d-block"],["type","text","id","cml_id","nbInput","","fieldSize","small","required","","name","cml_id",3,"ngModel"],["for","gauge_point",1,"d-block"],["type","text","id","gauge_point","nbInput","","fieldSize","small","required","","name","gauge_point",3,"ngModel"],["for","point_location",1,"d-block"],["type","text","id","point_location","nbInput","","fieldSize","small","required","","name","point_location",3,"ngModel"],["for","last_thickness_reading",1,"d-block"],["type","text","id","last_thickness_reading","nbInput","","fieldSize","small","required","","name","last_thickness_reading",3,"ngModel"],["for","last_thickness_reading_date",1,"d-block"],["type","text","id","last_thickness_reading_date","required","","nbInput","","fieldSize","small","name","last_thickness_reading_date",3,"nbDatepicker","ngModel"],["datepicker",""],["nbButton","","size","small","status","success","type","submit",1,"mt-2","w-100",3,"disabled"]],template:function(e,n){if(1&e){const i=t.EpF();t.TgZ(0,"div",0)(1,"nb-card",1)(2,"nb-card-header",2)(3,"h5",3),t._uU(4),t.qZA(),t.TgZ(5,"div",4)(6,"button",5),t.NdJ("click",function(){return n.closeDialog()}),t._UZ(7,"nb-icon",6),t.qZA()()(),t.TgZ(8,"nb-card-body")(9,"form",7,8),t.NdJ("ngSubmit",function(){t.CHM(i);const u=t.MAs(10);return n.closeDialog(u.value)}),t.TgZ(11,"div",9)(12,"div")(13,"label",10),t._uU(14,"CML ID"),t.qZA(),t._UZ(15,"input",11),t.TgZ(16,"label",12),t._uU(17,"Gaguge Point"),t.qZA(),t._UZ(18,"input",13),t.TgZ(19,"label",14),t._uU(20,"Point Location"),t.qZA(),t._UZ(21,"input",15),t.TgZ(22,"label",16),t._uU(23,"Last Thickness Reading"),t.qZA(),t._UZ(24,"input",17),t.TgZ(25,"label",18),t._uU(26,"Last Thickness Reading Date"),t.qZA(),t._UZ(27,"input",19)(28,"nb-datepicker",null,20),t.qZA(),t.TgZ(30,"button",21),t._uU(31),t.qZA()()()()()()}if(2&e){const i=t.MAs(10),l=t.MAs(29);t.xp6(4),t.Oqu(null==n.dialogData?null:n.dialogData.title),t.xp6(11),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.cml_id),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.gauge_point),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.point_location),t.xp6(3),t.Q6J("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.last_thickness_reading),t.xp6(3),t.Q6J("nbDatepicker",l)("ngModel",null==n.dialogData||null==n.dialogData.data?null:n.dialogData.data.last_thickness_reading_date),t.xp6(3),t.Q6J("disabled",!i.form.valid),t.xp6(1),t.Oqu(null==n.dialogData?null:n.dialogData.title)}},directives:[s.Asz,s.ndF,s.DPz,s.fMN,s.yKW,p._Y,p.JL,p.F,s.h8i,p.Fj,p.Q7,p.JJ,p.On,s.$kf,s.B4C],encapsulation:2}),a})();var M=r(3858),v=r(3872),y=r(574),x=r(4641),f=r.n(x),k=r(8493),T=r(7238),Z=r.n(T);const F=["pdfThickness"];function A(a,o){if(1&a&&(t.TgZ(0,"th")(1,"b",7),t._uU(2),t.qZA()()),2&a){const e=o.$implicit;t.xp6(2),t.Oqu(e.name)}}function S(a,o){if(1&a&&(t.TgZ(0,"td"),t._uU(1),t.qZA()),2&a){const e=o.$implicit,n=t.oxw().$implicit;t.xp6(1),t.hij(" ",null==n?null:n[e.props]," ")}}function P(a,o){if(1&a&&(t.TgZ(0,"tr"),t.YNc(1,S,2,1,"td",6),t.qZA()),2&a){const e=t.oxw(2);t.xp6(1),t.Q6J("ngForOf",e.pdfHead)}}function O(a,o){if(1&a&&(t.TgZ(0,"table",5)(1,"tr"),t.YNc(2,A,3,1,"th",6),t.qZA(),t.YNc(3,P,2,1,"tr",6),t.qZA()),2&a){const e=t.oxw();t.Akn(e.tableStyle),t.xp6(2),t.Q6J("ngForOf",e.pdfHead),t.xp6(1),t.Q6J("ngForOf",e.tableData)}}f().vfs=k.I.vfs;let D=(()=>{class a{constructor(){this.tableStyle={"font-size":"12px"},this.pdfHead=[{name:"Id",props:"cml_id",width:"*"},{name:"Gauge Point",props:"gauge_point",width:"auto"},{name:"Location",props:"point_location",width:"auto"},{name:"Nom Thickness",props:"nominal_thickness",width:"auto"},{name:"Min Req Thickness",props:"min_required_thickness",width:"auto"},{name:"Last Thick Read",props:"last_thickness_reading",width:"auto"},{name:"Last Thick Date",props:"last_thickness_reading_date",width:"auto"},{name:"Calc CR",props:"calculated_cr",width:"*"}]}ngOnInit(){f().tableLayouts={exampleLayout:{hLineWidth:function(e,n){return 0===e||e===n.table.body.length?0:e===n.table.headerRows?2:1},vLineWidth:function(e){return 0},hLineColor:function(e){return 1===e?"black":"#aaa"},paddingLeft:function(e){return 0===e?0:8},paddingRight:function(e,n){return e===n.table.widths.length-1?0:8}}}}generateData(e){this.tableData=e,console.log(e),setTimeout(()=>{this.downloadAsPDF()},500)}downloadAsPDF(){const e=this.pdfThickness.nativeElement;let n=Z()(e.innerHTML);console.log(n);const i={content:[n],pageBreakBefore:function(l){return l.style&&l.style.indexOf("pdf-pagebreak-before")>-1}};f().createPdf(i).open()}}return a.\u0275fac=function(e){return new(e||a)},a.\u0275cmp=t.Xpm({type:a,selectors:[["cml-pdf"]],viewQuery:function(e,n){if(1&e&&t.Gf(F,5),2&e){let i;t.iGM(i=t.CRH())&&(n.pdfThickness=i.first)}},decls:6,vars:1,consts:[[1,"container",2,"display","none"],["id","Thickness"],["pdfThickness",""],[2,"width","100%","margin","0 0 1rem 0","color","#5588EE"],["data-pdfmake",'{"widths":["auto", "auto", "auto", "auto", "auto", "auto", "auto", "auto"], "layout" : "exampleLayout"}',3,"style",4,"ngIf"],["data-pdfmake",'{"widths":["auto", "auto", "auto", "auto", "auto", "auto", "auto", "auto"], "layout" : "exampleLayout"}'],[4,"ngFor","ngForOf"],[2,"font-weight","bold"]],template:function(e,n){1&e&&(t.TgZ(0,"div",0)(1,"div",1,2)(3,"h5",3),t._uU(4,"CML"),t.qZA(),t.YNc(5,O,4,4,"table",4),t.qZA()()),2&e&&(t.xp6(5),t.Q6J("ngIf",n.tableData))},directives:[h.O5,h.sg],encapsulation:2}),a})();var U=r(2340),w=r(520);let Y=(()=>{class a{constructor(e){this.httpClient=e,this.apiUrl=U.N.apiUrl}getCMLs(){return this.httpClient.get(this.apiUrl+"/cml")}getCML(e){return this.httpClient.get(this.apiUrl+"/cml/"+e)}addCML(e){return this.httpClient.post(this.apiUrl+"/cml",e)}deleteCML(e){return this.httpClient.delete(this.apiUrl+"/cml/"+e)}updateCML(e){return this.httpClient.put(this.apiUrl+"/cml/"+e.id,e)}importCML(e){return this.httpClient.post(this.apiUrl+"/import_cmls",e)}}return a.\u0275fac=function(e){return new(e||a)(t.LFG(w.eN))},a.\u0275prov=t.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})();var I=r(7024);function q(a,o){if(1&a){const e=t.EpF();t.TgZ(0,"button",2),t.NdJ("click",function(){const l=t.CHM(e).$implicit,u=t.MAs(2),c=t.oxw();return"New"==l.name?c.addCML():"Import"==l.name?u.click():"Export"==l.name?c.exportExcelFile():"Print"==l.name?c.printCML():null}),t.TgZ(1,"input",3,4),t.NdJ("change",function(i){return t.CHM(e),t.oxw().importExcelFile(i)}),t.qZA(),t._UZ(3,"nb-icon",5),t.TgZ(4,"span"),t._uU(5),t.qZA()()}if(2&a){const e=o.$implicit,n=t.oxw();let i;t.Q6J("disabled",!("Export"!=(null==e?null:e.name)&&"Print"!=(null==e?null:e.name)||null!=n.tableData&&n.tableData.length)),t.xp6(3),t.Q6J("icon",e.icon)("pack",null!==(i=e.pack)&&void 0!==i?i:"eva"),t.xp6(2),t.Oqu(e.name)}}const J=function(){return{name:"New",icon:"plus-outline"}},R=function(){return{name:"Import",icon:"download-outline"}},z=function(){return{name:"Export",icon:"upload-outline"}},N=function(){return{name:"Print",icon:"printer-outline"}},Q=function(a,o,e,n){return[a,o,e,n]},j=[{path:"",component:(()=>{class a{constructor(e,n,i,l,u,c){this.activatedroute=e,this.cmlService=n,this.dialogService=i,this.datePipe=l,this.toastrService=u,this.variables=c,this.tableData=[],this.columnDetails=[{type:"text",prop:"cml_id",head:"CML Id",width:"200px"},{type:"text",prop:"gauge_point",head:"Gauge Point",width:"200px"},{type:"text",prop:"point_location",head:"Point Location",width:"200px"},{type:"text",prop:"nominal_thickness",head:"Nominal Thickness (mm)",width:"200px"},{type:"text",prop:"min_required_thickness",head:"Min. Required Thickness (mm)",width:"200px"},{type:"text",prop:"last_thickness_reading",head:"Last Thickness Reading (mm)",width:"200px"},{type:"text",prop:"last_thickness_reading_date",head:"Last Thickness Date",width:"200px"},{type:"text",prop:"calculated_cr",head:"Calculated CR (mm/Year)",width:"200px"},{type:"button",prop:"edit",width:"80px",button:[{icon:"edit-outline",status:"info",title:"edit-cml"},{icon:"trash-2-outline",status:"danger",title:"delete-cml"}]}],this.transformExcelDate=d=>null==d?"":new Date(Math.round(86400*(d-25569)*1e3))}ngOnInit(){this.pipingId=this.activatedroute.snapshot.paramMap.get("id"),this.cmlService.getCML(this.pipingId).subscribe(({data:e,piping:n})=>{this.piping=n;let i=["All"];this.tableHeader={title:n.piping_id,filter:[{name:"Year",value:i.sort((c,d)=>c-d),title:"cml-year"}]};const{nominal_thickness:l,min_required_thickness:u}=this.variables.getAssetsFormula(n);this.tableData=e.map(c=>{const d=this.variables.getCalculatedLTCR(Object.assign(Object.assign({},c),n));return i.includes(c.year)||i.push(c.year),Object.assign(Object.assign({},c),{nominal_thickness:l,min_required_thickness:u.toFixed(4),calculated_cr:d.toFixed(3)})}),this.viewTable.regenerateTable(this.tableData)})}onClickTable(e,n){if("delete-cml"==n&&this.deleteCML(e),"edit-cml"==n&&this.updateCML(e),"cml-year"==n){let i;i="All"==e?this.tableData:this.tableData.filter(({year:l})=>l==e),this.viewTable.regenerateTable(i)}}exportExcelFile(){console.log("export")}printCML(){this.CMLPDF.generateData(this.tableData)}addCML(){this.dialogService.open(_,{context:{dialogData:{title:"Add CML"}}}).onClose.subscribe(e=>{e&&(e=this.reconstructCMLData(e),this.cmlService.addCML(e).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success.")))})}updateCML(e){this.dialogService.open(_,{context:{dialogData:{title:"Update CML",data:Object.assign(Object.assign({},e),{last_thickness_reading_date:new Date(e.last_thickness_reading_date)})}}}).onClose.subscribe(n=>{n&&(n=Object.assign(Object.assign({},this.reconstructCMLData(n)),{id:e.id}),this.cmlService.updateCML(n).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success.")))})}reconstructCMLData(e){return Object.assign(Object.assign({},e),{piping_id:this.piping.id,last_thickness_reading_date:this.datePipe.transform(e.last_thickness_reading_date,"yyyy-MM-dd"),year:new Date(e.last_thickness_reading_date).getFullYear()})}deleteCML(e){this.dialogService.open(v.F,{context:{dialogData:{title:"Add CML",name:e.cml_id,id:e.id}}}).onClose.subscribe(n=>{n&&this.cmlService.deleteCML(n.id).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been deleted.","Your request success."))})}importExcelFile(e){const n=e.target.files[0];if(!n)return;const i=new FileReader;i.readAsBinaryString(n),i.onload=l=>{const c=y.ij(l.target.result,{type:"binary"});console.log(c);const d=c.Sheets[c.SheetNames[0]];let m=0,b=!0;for(;b;){if(m>100&&(b=!1),d["A"+m]){b=!1;break}m++}const K=y.P6.sheet_to_json(d,{range:m-1,defval:""});this.reconstructDataExcel(K)}}reconstructDataExcel(e){const n=e.map(({"CML ID":i,"Gauge Point":l,"Point Location":u,"Last Thickness":c,"Last Thickness Reading Date":d})=>{d=this.transformExcelDate(d);const m=new Date(d).getFullYear();return{cml_id:i,gauge_point:l,point_location:u,last_thickness_reading:c,last_thickness_reading_date:d=this.datePipe.transform(d,"yyyy-MM-dd"),year:m,piping_id:this.pipingId}});this.cmlService.importCML(n).subscribe(()=>this.ngOnInit(),()=>this.toastrService.danger("Please check your connection and try again.","Your request failed."),()=>this.toastrService.success("Data has been added.","Your request success."))}}return a.\u0275fac=function(e){return new(e||a)(t.Y36(g.gz),t.Y36(Y),t.Y36(s.Gln),t.Y36(h.uU),t.Y36(s.quB),t.Y36(I.L))},a.\u0275cmp=t.Xpm({type:a,selectors:[["ngx-cml"]],viewQuery:function(e,n){if(1&e&&(t.Gf(M.V,5),t.Gf(D,5)),2&e){let i;t.iGM(i=t.CRH())&&(n.viewTable=i.first),t.iGM(i=t.CRH())&&(n.CMLPDF=i.first)}},decls:5,vars:13,consts:[["nbButton","","outline","","size","small","status","primary","class","m-2",3,"disabled","click",4,"ngFor","ngForOf"],[3,"tableHeader","columnDetails","tableData","onClickTable"],["nbButton","","outline","","size","small","status","primary",1,"m-2",3,"disabled","click"],["type","file","accept",".xls,.xlsx",2,"display","none",3,"change"],["importExcel",""],[1,"m-1",3,"icon","pack"]],template:function(e,n){1&e&&(t.TgZ(0,"nb-card")(1,"nb-card-body"),t.YNc(2,q,6,4,"button",0),t.qZA()(),t.TgZ(3,"ngx-mat-table",1),t.NdJ("onClickTable",function(l){return n.onClickTable(l.data,l.title)}),t.qZA(),t._UZ(4,"cml-pdf")),2&e&&(t.xp6(2),t.Q6J("ngForOf",t.l5B(8,Q,t.DdM(4,J),t.DdM(5,R),t.DdM(6,z),t.DdM(7,N))),t.xp6(1),t.Q6J("tableHeader",n.tableHeader)("columnDetails",n.columnDetails)("tableData",n.tableData))},directives:[s.Asz,s.yKW,h.sg,s.DPz,s.fMN,M.V,D],encapsulation:2}),a.\u0275prov=t.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})(),data:{routename:"cml"}}];let E=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.oAB({type:a}),a.\u0275inj=t.cJS({imports:[[g.Bz.forChild(j)],g.Bz]}),a})();var B=r(2356),H=r(9511);let G=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.oAB({type:a}),a.\u0275inj=t.cJS({imports:[[h.ez,L.O,E,s.zyh,s.KdK,s.nKr,s.T2N,B.Z,H.H,p.u5,s.OA,s.LW9.forRoot({destroyByClick:!0,duration:3e3,position:s.fe3.BOTTOM_RIGHT,preventDuplicates:!0,limit:3})]]}),a})()}}]);